---
title: "script_result_vis.rmd"
output: html_document
date: '2022-08-22'
---


#visualizing model error results per country and variant
> exploring the effect of sequencing efforts in model errors
> how do models preform differently in nowcasting and forecasting variant frequencies?




```{r}
library(dplyr)
library(ggplot2)
library(tidyverse)
library(lubridate)
library(data.table)
library(yarrr)
library(ggpirate)
library(vioplot)
library(patchwork)
library(scales)
library(ggbeeswarm)
library(ggpubr)
library(hrbrthemes)
library(bbplot)
library(viridis)
library(extrafont)
library(ggridges)
library(ggthemes)
library(gtExtras)
library(remotes)
library(gtsummary)
library(magrittr)
library(gt)


```


#reading datasets

```{r}

#read error datasets
error_dataset = read.csv('estimates/model_scores_output3.csv') %>%
  mutate(model = recode(model, dummy = "Naïve")) 


error_dataset2 = read.csv('estimates/model_scores_output4.csv') %>%
  mutate(model = recode(model, dummy = "Naïve")) 

#growth advantage dataset per variant
growthadv_dataset = read.csv("estimates/ga_output.csv")



#add pivot_date column to each dataset for figure 1 plot 2
seqs1 = read.csv("data/time_stamped/2022-04-22/seq_counts_2022-04-22.tsv", sep = "\t")
seqs2 = read.csv("data/time_stamped/truth/seq_counts_truth.tsv",sep = "\t")


#seq by submitted date

seq_date = read.csv("data/seq_counts_delayed.tsv" ,sep = "\t")


#schematic figure data
seqs_first = read.csv("data/time_stamped/2022-04-22/seq_counts_2022-04-22.tsv", sep = "\t")
seq_mid =  read.csv("data/time_stamped/2022-05-20/seq_counts_2022-05-20.tsv", sep = "\t") 
seq_last =  read.csv("data/time_stamped/2022-06-30/seq_counts_2022-06-30.tsv", sep = "\t")



```

#Mapping colors

```{r}

low_color = "#CCF4D2"
high_color = "#2C9191"

#Variant colors
#,"#E67A32",	"#DB2823", 
variant_colors = c("Delta" = "#926224",		"Omicron 21K" = "#781C86", "Omicron 21L" = "#83BA70","Omicron 22A" = "#D3AE4E", "Omicron 22B" ="#574BD3", "Omicron 22C" = "#DF4327", "other" = "grey")

variant_colorsga = c("Delta" = "#926224",		"Omicron 21K" = "#781C86","Omicron 22A" = "#D3AE4E", "Omicron 22B" ="#574BD3", "Omicron 22C" = "#DF4327", "other" = "grey")




model_colors = c("Naïve"= "#5E0035", "Piantham" ="#17BEBB", "MLR" = "#003049", "FGA" = "#FFCF00","GARW" = "#D62828" )


```






# Figure 1B: how forecasts can diverge depending on estimation time


```{r}

#plotting MA smoothed frequency with posterior predicted freqs

#USA
freq_plot_US = error_dataset %>% 
  filter(location =="USA" &
           model =="GARW", na.rm= TRUE) %>%
  filter(variant != "other" & variant != "Delta") %>%
  ggplot() +
    geom_line(aes(x = as.Date(date), y = smoothed_freq) ,color = "darkgrey" ,size = 1.2)+
  geom_line(aes(x = as.Date(date), y = pred_freq,  group = factor(pivot_date),color = factor(variant), fill = factor(pivot_date)),size = 0.8, alpha = 0.7)+
  facet_wrap(~variant, nrow = 1)+
  bbc_style()+
  scale_color_manual(
    values= variant_colors,
    limits = c(	"Omicron 21K", "Omicron 21L","Omicron 22A",  "Omicron 22B", "Omicron 22C" )
  )+
  labs( x = "Date", y= "Frequency",
        caption = "MA smoothed frequency with predicted frequency")+
  theme(axis.title.x = element_text(color="Black", size=14),
        axis.title.y = element_text(color="Black", size=14),
        panel.grid.major = element_line(),
        axis.line = element_line(colour = "black"),
        panel.grid.major.y = element_blank(),
        panel.grid.minor.y = element_blank(),
        strip.text.x = element_text(size = 15),
        legend.text = element_text(size = 12),
        axis.text.x = element_text(size = 12),
        axis.text.y = element_text(size = 12),
        axis.ticks = element_line(), 
        strip.text.y = element_text(size = 11),
        plot.title = element_text(family = "Helvetica", size = (12)),
        legend.position = "none",
        plot.subtitle  = element_text(size = 14)) + labs(subtitle = "USA") +
  ylim(0,1)

freq_plot_US


#Japan

freq_plot_JA = error_dataset %>% 
  filter(location =="Japan" &
           model =="GARW", na.rm= TRUE) %>%
  filter(variant != "other" & variant != "Delta") %>%
  ggplot() +
    geom_line(aes(x = as.Date(date), y = smoothed_freq) ,color = "darkgrey" ,size = 1.2)+
  geom_line(aes(x = as.Date(date), y = pred_freq,  group = factor(pivot_date),color = factor(variant)),size = 0.8, alpha = 0.7)+
    scale_color_manual(
    values= variant_colors,
    limits = c(	"Omicron 21K", "Omicron 21L","Omicron 22A",  "Omicron 22B", "Omicron 22C" ))+
  facet_wrap(~variant, nrow = 1)+
  bbc_style()+

  labs( x = "Date", y= "Frequency",
        caption = "MA smoothed frequency with predicted frequency")+
  theme(axis.title.x = element_blank(),
        axis.title.y = element_text(color="Black", size=14),
        panel.grid.major = element_line(),
        axis.line = element_line(colour = "black"),
        panel.grid.major.y = element_blank(),
        panel.grid.minor.y = element_blank(),
        strip.text.x = element_text(size = 15),
        legend.text = element_text(size = 12),
        axis.text.x = element_text(size = 12),
        axis.text.y = element_text(size = 12),
        axis.ticks = element_line(), 
        strip.text.y = element_text(size = 11),
        plot.title = element_text(family = "Helvetica", size = (12)),
        legend.position = "right",
        plot.subtitle  = element_text(size = 14)) + labs(subtitle = "Japan") +
  ylim(0,1)
  
freq_plot_JA

freq_plot_US/freq_plot_JA








```


#Figure 1A: Schematic

```{r}
#First estimated date
Initial_date = seqs_first %>%
  filter(location =="USA") %>%
  ggplot() +
  geom_col(aes(x = as.Date(date), y = sequences, fill = variant), alpha = 0.9) +
  theme_classic()+
    theme(rect = element_rect(fill = "transparent"),
        plot.background = element_rect(fill = "transparent",colour = NA_character_),
        panel.background = element_rect(fill = "transparent",colour = NA_character_),
        legend.position = "bottom",
        axis.text.y = element_text(colour = "black"),
        axis.text.x = element_text(colour = "black"))+
  scale_fill_manual(values =variant_colors )+
  xlab("Date")+
  labs(subtitle = "USA ")+
  scale_x_date(date_breaks = "1 month",
               labels=label_date_short(),
               limits = as.Date(c('2022-02-20','2022-06-15'))) +
  ylim(0,8000)
  
Initial_date


#Mid estimation date
mid_date =seq_mid %>%
  filter(location =="USA") %>%
  ggplot() +
  geom_col(aes(x = as.Date(date), y = sequences, fill = variant), alpha = 0.9) +
  theme_classic() +
  scale_fill_manual(values =variant_colors )+
  theme(rect = element_rect(fill = "transparent"),
        plot.background = element_rect(fill = "transparent",colour = NA_character_),
        panel.background = element_rect(fill = "transparent", colour = NA_character_),
        legend.position = "bottom",
        axis.text.y = element_text(colour = "black"),
        axis.text.x = element_text(colour = "black"))+
  labs(subtitle = "USA ")+
  xlab("Date")+
  scale_x_date(date_breaks = "1 month",
               labels=label_date_short(),
               limits = as.Date(c('2022-02-20','2022-06-15')))+
  ylim(0,8000)


#Late estimation date

later_date =seq_last %>%
  filter(location =="USA") %>%
  ggplot() +
  geom_col(aes(x = as.Date(date), y = sequences, fill = variant), alpha = 0.9) +
  theme_classic() +
  scale_fill_manual(values =variant_colors )+
  theme(rect = element_rect(fill = "transparent"),
        plot.background = element_rect(fill = "transparent",colour = NA_character_),
          panel.background = element_rect(fill = "transparent",colour = NA_character_),
        legend.position = "bottom",
           axis.text.y = element_text(colour = "black"),
           axis.text.x = element_text(colour = "black"))+
  labs(subtitle = "USA")+
  xlab("Date")+
  scale_x_date(date_breaks = "1 month",
               labels=label_date_short(),
               limits = as.Date(c('2022-02-20','2022-06-30')))+
  ylim(0,8000)

later_date


full_plot_schem = Initial_date+mid_date +later_date  & theme(legend.position = "bottom")
full_plot_schem = full_plot_schem + plot_layout(guides = "collect")
apply_consistent_y_lims(full_plot_schem)

full_plot_schem

ggsave("later_est.png", plot = later_date, width = 7, height = 10, units = "cm", bg = 'transparent')
ggsave("mid_est.png", plot = mid_date, width = 7, height = 10, units = "cm", bg = 'transparent')
ggsave("initial_est.png", plot = Initial_date, width = 7, height = 10, units = "cm", bg = 'transparent')

ggsave("full_plot_schem.png", plot = full_plot_schem, width = 20, height = 20, units = "cm", bg = 'transparent')
```


```{r}

#First estimated date
Initial_dateJ = seqs_first %>%
  filter(location =="Japan") %>%
  ggplot() +
  geom_col(aes(x = as.Date(date), y = sequences, fill = variant), alpha = 0.9) +
  theme_classic()+
    theme(rect = element_rect(fill = "transparent"),
        plot.background = element_rect(fill = "transparent",colour = NA_character_),
        panel.background = element_rect(fill = "transparent",colour = NA_character_),
        legend.position = "bottom",
        axis.text.y = element_text(colour = "black"),
        axis.text.x = element_text(colour = "black"))+
  scale_fill_manual(values =variant_colors )+
  xlab("Date")+
  labs(subtitle = "Japan ")+
  scale_x_date(date_breaks = "1 month",
               labels=label_date_short(),
               limits = as.Date(c('2022-02-20','2022-06-15')))+
  ylim(0,1500)
  
Initial_date


#Mid estimation date
mid_dateJ =seq_mid %>%
  filter(location =="Japan") %>%
  ggplot() +
  geom_col(aes(x = as.Date(date), y = sequences, fill = variant), alpha = 0.9) +
  theme_classic() +
  scale_fill_manual(values =variant_colors )+
  theme(rect = element_rect(fill = "transparent"),
        plot.background = element_rect(fill = "transparent",colour = NA_character_),
        panel.background = element_rect(fill = "transparent", colour = NA_character_),
        legend.position = "bottom",
        axis.text.y = element_text(colour = "black"),
        axis.text.x = element_text(colour = "black"))+
  labs(subtitle = "Japan ")+
  xlab("Date")+
  scale_x_date(date_breaks = "1 month",
               labels=label_date_short(),
               limits = as.Date(c('2022-02-20','2022-06-15')))+
  ylim(0,1500)
mid_dateJ

#Late estimation date

later_dateJ =seq_last %>%
  filter(location =="Japan") %>%
  ggplot() +
  geom_col(aes(x = as.Date(date), y = sequences, fill = variant), alpha = 0.9) +
  theme_classic() +
  scale_fill_manual(values =variant_colors )+
  theme(rect = element_rect(fill = "transparent"),
        plot.background = element_rect(fill = "transparent",colour = NA_character_),
          panel.background = element_rect(fill = "transparent",colour = NA_character_),
        legend.position = "bottom",
           axis.text.y = element_text(colour = "black"),
           axis.text.x = element_text(colour = "black"))+
  labs(subtitle = "Japan")+
  xlab("Date")+
  scale_x_date(date_breaks = "1 month",
               labels=label_date_short(),
               limits = as.Date(c('2022-02-20','2022-06-30')))+
  ylim(0,1500)

later_dateJ



ggsave("later_estj.png", plot = later_dateJ, width = 7, height = 10, units = "cm", bg = 'transparent')
ggsave("mid_estj.png", plot = mid_dateJ, width = 7, height = 10, units = "cm", bg = 'transparent')
ggsave("initial_estj.png", plot = Initial_dateJ, width = 7, height = 10, units = "cm", bg = 'transparent')


ggsave("legend.png", plot = Initial_dateJ, width = 15, height = 10, units = "cm", bg = 'transparent')





```


#Figure 1: Final


```{r}

Figure_1A= ((freq_plot_JA + labs(title = "B")))  + ((freq_plot_US + labs(title = "C")))  +
  plot_layout(guides = "collect", ncol =1, tag_level = "new" ) 



ggsave("figure1A.png", plot = Figure_1A, width = 25, height = 15, units = "cm", bg = 'transparent')


Figure_1= submit_delay + freq_plot  +
  plot_layout(guides = "collect", ncol = 1) +
  plot_annotation(title = 'United States',
                  tag_levels = 'A')
  

Figure_1
ggsave("figure1.png", plot = Figure_1, width = 20, height = 20, units = "cm", bg = 'transparent')
```





# Analysis 1: (Figure 2A, 2B) Model Evaluation and Comparison


#Figure 2A: Model comparison with error quantiles


```{r}
#plotting error quantile 
error_quantiles_mae = error_dataset %>%
  filter(lead > -14) %>%
  group_by(lead, location, model) %>%
  #filter(location =="USA") %>%
  summarise(quant75 = quantile(MAE, probs = c(.75), na.rm = TRUE),
            quant50 = quantile(MAE, probs = c(.50), na.rm = TRUE),
            quant25 = quantile(MAE, probs = c(.25), na.rm = TRUE)) %>%
  ggplot(aes(x = lead, color = model)) +
  geom_line(aes(y = quant75, linetype = '75th Quantile'), alpha= 0.6, size = 1, se= FALSE)+
  geom_line(aes(y = quant50, linetype = '50th Quantile'), size = 1)+
  geom_point(aes(y = quant50, shape = model), size = 1.2, alpha = 0.75)+
  geom_line(aes(y = quant25, linetype = '25th Quantile'), alpha = 0.6, size = 1, se= FALSE)+
  facet_wrap(~location) +
  bbc_style()+
  labs(linetype="Quantile", color = "Model", shape = "")+
  scale_linetype_manual(values = c("dotted","solid","dashed"),
                        labels = c("25th Quantile","Median", "75th Quantile" ))+
  scale_color_manual(values=model_colors)+
  labs( x = "Days from date of estimation", y= "MAE")+
  theme(axis.title.x = element_text(color="Black", size=14),
        axis.title.y = element_text(color="Black", size=14),
        panel.grid.major = element_line(),
        axis.line = element_line(colour = "black"),
        panel.grid.major.y = element_blank(),
        #panel.grid.minor.y = element_blank(),
        strip.text.x = element_text(size = 13),
        legend.text = element_text(size = 12),
        axis.text.x = element_text(size = 12),
        axis.text.y = element_text(size = 12),
        axis.ticks = element_line(), 
        strip.text.y = element_text(size = 11),
        plot.title = element_text(family = "Helvetica", size = (12)),
        legend.position = "right",
        legend.title = element_text(size = 12))+
  scale_x_discrete(limits = c(-14 ,-7 , 0 , 7, 14),
                   breaks = c(-14 ,-7 , 0 , 7, 14),
                   expand = expansion(mult  = 0.12)) +
  scale_y_continuous(trans = log_trans(),
                     breaks = trans_breaks('log10', function(x) 10^x),
                     labels = trans_format('log10', math_format(10^.x)))+
  #ylim(0,2)+

  annotate(geom = "rect", xmin = -14, xmax = 0, 
                ymin = 0, ymax = 5,
            color = NA, 
            fill = "#bdc3c7", alpha = 0.15)+
    annotate(geom = "text", x = -8, y  =2,
             label= "Nowcast", size  = 3,
             fontface = "bold")+
   annotate(geom = "rect", xmin = 0, xmax = 14, 
                ymin = 0, ymax = 5,
            color = NA, 
            fill = "#2c3e50", alpha = 0.15)+
      annotate(geom = "text", x = 6, y  =2,
             label= "Forecast", size  = 3,
             fontface = "bold")
error_quantiles_mae

ggsave("figure2.png", plot = error_quantiles_mae, width = 25, height = 20, units = "cm", bg = 'transparent')

  
```



```{r}

#plotting error quantile 
error_dataset2 %>%
  #filter(lead > -14) %>%
  group_by(lead, location, model) %>%
  #filter(location =="USA") %>%
  summarise(quant75 = quantile(MAE, probs = c(.75), na.rm = TRUE),
            quant50 = quantile(MAE, probs = c(.50), na.rm = TRUE),
            quant25 = quantile(MAE, probs = c(.25), na.rm = TRUE)) %>%
  ggplot(aes(x = lead, color = model)) +
  geom_line(aes(y = quant75, linetype = '75th Quantile'), alpha= 0.6, size = 1, se= FALSE)+
  geom_line(aes(y = quant50, linetype = '50th Quantile'), size = 1)+
  geom_point(aes(y = quant50), size = 1.2, alpha = 0.75)+
  geom_line(aes(y = quant25, linetype = '25th Quantile'), alpha = 0.6, size = 1, se= FALSE)+
  facet_wrap(~location) +
  bbc_style()+
  labs(linetype="Quantile", color = "Model", shape = "")+
  scale_linetype_manual(values = c("dotted","solid","dashed"),
                        labels = c("25th Quantile","Median", "75th Quantile" ))+
  scale_color_manual(values=model_colors)+
  labs( x = "Days from date of estimation", y= "MAE")+
  theme(axis.title.x = element_text(color="Black", size=14),
        axis.title.y = element_text(color="Black", size=14),
        panel.grid.major = element_line(),
        axis.line = element_line(colour = "black"),
        panel.grid.major.y = element_blank(),
        #panel.grid.minor.y = element_blank(),
        strip.text.x = element_text(size = 13),
        legend.text = element_text(size = 12),
        axis.text.x = element_text(size = 12),
        axis.text.y = element_text(size = 12),
        axis.ticks = element_line(), 
        strip.text.y = element_text(size = 11),
        plot.title = element_text(family = "Helvetica", size = (12)),
        legend.position = "right",
        legend.title = element_text(size = 12))+
  scale_y_continuous(trans = log_trans(),
                     breaks = trans_breaks('log10', function(x) 10^x),
                     labels = trans_format('log10', math_format(10^.x)))
+
  scale_x_discrete(limits = c(-14 ,-7 , 0 , 7, 14),
                   breaks = c(-14 ,-7 , 0 , 7, 14),
                   expand = expansion(mult  = 0.12)) +
  scale_y_continuous(trans = log_trans(),
                     breaks = trans_breaks('log10', function(x) 10^x),
                     labels = trans_format('log10', math_format(10^.x)))+
  #ylim(0,2)+

  annotate(geom = "rect", xmin = -14, xmax = 0, 
                ymin = 0, ymax = 5,
            color = NA, 
            fill = "#bdc3c7", alpha = 0.15)+
    annotate(geom = "text", x = -8, y  =2,
             label= "Nowcast", size  = 3,
             fontface = "bold")+
   annotate(geom = "rect", xmin = 0, xmax = 14, 
                ymin = 0, ymax = 5,
            color = NA, 
            fill = "#2c3e50", alpha = 0.15)+
      annotate(geom = "text", x = 6, y  =2,
             label= "Forecast", size  = 3,
             fontface = "bold")
error_quantiles_mae


```




```{r}


#need geom_line, violin plot would be to crowded for each lead date and would either overlap or make it too large


#plotting error quantile 
error_dataset %>%
 # filter(lead > -14) %>%
  group_by(lead, location, model) %>%
  #filter(location =="USA") %>%
  #summarise(quant75 = quantile(MAE, probs = c(.75), na.rm = TRUE),
  #          quant50 = quantile(MAE, probs = c(.50), na.rm = TRUE),
  #          quant25 = quantile(MAE, probs = c(.25), na.rm = TRUE)) %>%
  ggplot(aes(x = factor(lead), fill = model)) +
  geom_violin(aes(y = sqrt(MAE)), alpha= 0.6, size = 1, se= FALSE)+
  #geom_violin(aes(y = quant50, linetype = '50th Quantile'), size = 1)+
  #geom_point(aes(y = quant50), size = 1.2, alpha = 0.75)+
  #geom_violin(aes(y = quant25, linetype = '25th Quantile'), alpha = 0.6, size = 1, se= FALSE)+
  facet_wrap(~location) +
  bbc_style()+
  #labs(linetype="Quantile")+
  #scale_linetype_manual(values = c("dotted","solid","dashed"),
  #                      labels = c("25th Quantile","Median", "75th Quantile" ))+
  scale_fill_manual(values=model_colors)+
  labs( x = "Days from date of estimation", y= "MAE")+
  theme(axis.title.x = element_text(color="Black", size=14),
        axis.title.y = element_text(color="Black", size=14),
        panel.grid.major = element_line(),
        axis.line = element_line(colour = "black"),
        panel.grid.major.y = element_blank(),
        #panel.grid.minor.y = element_blank(),
        strip.text.x = element_text(size = 13),
        legend.text = element_text(size = 12),
        axis.text.x = element_text(size = 12),
        axis.text.y = element_text(size = 12),
        axis.ticks = element_line(), 
        strip.text.y = element_text(size = 11),
        plot.title = element_text(family = "Helvetica", size = (12)),
        legend.position = "right",
        legend.title = element_text(size = 12))+
 scale_x_discrete(limits = c(-14 ,-7 , 0 , 7, 14),
                  breaks = c(-14 ,-7 , 0 , 7, 14),
                   expand = expansion(mult  = 0.12)) 
  #scale_y_continuous(trans = log_trans(),
   #                  breaks = trans_breaks('log10', function(x) 10^x),
    #                 labels = trans_format('log10', math_format(10^.x)))












```

#Figure 2B: different pivot dates error distribution at important lead time points


```{r}

#violin plot

lags = as_labeller(c("-13" = "-14 Lag", "0" = "0 Lag","14"= "14 Lag"))


mae_dist = error_dataset %>%
  filter(lead %in% c(0,14,-13)) %>%
  group_by(lead, location, model) %>%
  ggplot(aes(y = sqrt(MAE), x = factor(model, levels = c("Naïve","Piantham","MLR","FGA","GARW")), fill = model)) +
  scale_fill_manual(values = model_colors)+
  geom_violin(lwd = 0.2,
              trim=FALSE, 
             position = "dodge", 
              alpha = 0.7,
            draw_quantiles = c(.25, .75), 
             colour = "black", show.legend = TRUE, inherit.aes = TRUE)+
  stat_summary(aes(x = factor(model), y = sqrt(MAE),col = "Mean"), fun= mean,
               geom = "crossbar", size = 0.3, alpha = 1, na.rm = TRUE, inherit.aes = FALSE)+
  scale_colour_manual(values = c("Q3" = "black",
                                 "Mean" = "black",
                                 "Q1" = "black"))+
    facet_wrap(~as.factor(lead), labeller = lags)+
  labs(colour="", fill = "")+
   geom_rangeframe(sides = "b", size = 0.5)+
   coord_cartesian(clip="off", expand = FALSE) +
  bbc_style()+
    labs(y = "MAE score distribution" )+
    theme(axis.title.x = element_blank(),
          axis.title.y = element_text(color="Black", size=14),
       panel.grid.major = element_line(),
        #axis.line = element_line(colour = "black"),
        panel.grid.major.y = element_blank(),
        strip.text.x = element_text(size = 13),
        legend.text = element_text(size = 12),
        axis.text.x = element_text(size = 12, angle = 90, hjust = 1, vjust = 0.5),
        axis.text.y = element_text(size = 12),
        axis.ticks = element_line(), 
        strip.text.y = element_text(size = 11),
        plot.title = element_text(family = "Helvetica", size = (12)),
        legend.position = "right",
        legend.title = element_text(size = 12),
       axis.ticks.length = unit(5, "pt"),
       axis.line.y = element_line(color="black", size = 0.5),
       aspect.ratio = 0.95)+
 scale_alpha(guide = 'none')  +
  scale_y_continuous(limit = c(-0.2,0.8),
                     breaks = c(0,0.4,0.8))


mae_dist


ggsave("figure2B.png", plot = mae_dist, width = 25, height = 15, units = "cm", bg ='transparent')


```






This plot shows the median RMSE error for each model, this provides a more detailed look on the behaviour of different models 

#Table 1: MAE mean error table



```{r}


table1 = error_dataset %>%
    filter(lead %in% c(0,14,-13)) %>%
    group_by(lead, model, location) %>%
  summarize(Mean = mean(MAE, na.rm = T)) %>%
  mutate_if(is.numeric, round, digits=3) %>%
  setDT() %>%
  pivot_wider(names_from= model, values_from = Mean)


table1$lead[table1$lead == "-13"] <- "-14"



table_1 = table1 %>%
      mutate(lead = paste(lead, "Lead from date of esimtation")) %>%
    group_by(lead)  %>%
  gt() %>%
  #-14 LEAD
    tab_style(style = list(
                         cell_text(weight = 'bold')), 
            locations = cells_body(columns= c(MLR), 
                                   rows = 1)) %>%
      tab_style(style = list(
                         cell_text(weight = 'bold')), 
            locations = cells_body(columns= c(GARW), 
                                   rows = 2)) %>%
      tab_style(style = list(
                         cell_text(weight = 'bold')), 
            locations = cells_body(columns= c(MLR), 
                                   rows = 3)) %>%
      tab_style(style = list(
                         cell_text(weight = 'bold')), 
            locations = cells_body(columns= c(FGA, GARW), 
                                   rows = 4)) %>%
      tab_style(style = list(
                         cell_text(weight = 'bold')), 
            locations = cells_body(columns= c(FGA, GARW), 
                                   rows = 5)) %>%
      tab_style(style = list(
                         cell_text(weight = 'bold')), 
            locations = cells_body(columns= c(GARW), 
                                   rows = 6)) %>%
  
  #0 LEAD
      tab_style(style = list(
                         cell_text(weight = 'bold')), 
            locations = cells_body(columns= c(MLR), 
                                   rows = 7)) %>%
      tab_style(style = list(
                         cell_text(weight = 'bold')), 
            locations = cells_body(columns= c(GARW), 
                                   rows = 8)) %>%
      tab_style(style = list(
                         cell_text(weight = 'bold')), 
            locations = cells_body(columns= c(MLR), 
                                   rows = 9)) %>%
      tab_style(style = list(
                         cell_text(weight = 'bold')), 
            locations = cells_body(columns= c(FGA, GARW), 
                                   rows = 10)) %>%
      tab_style(style = list(
                         cell_text(weight = 'bold')), 
            locations = cells_body(columns= c(FGA), 
                                   rows = 11)) %>%
      tab_style(style = list(
                         cell_text(weight = 'bold')), 
            locations = cells_body(columns= c(GARW), 
                                   rows = 12)) %>%
#12 LEAD
      tab_style(style = list(
                         cell_text(weight = 'bold')), 
            locations = cells_body(columns= c(MLR), 
                                   rows = 13)) %>%
      tab_style(style = list(
                         cell_text(weight = 'bold')), 
            locations = cells_body(columns= c(FGA), 
                                   rows = 14)) %>%
      tab_style(style = list(
                         cell_text(weight = 'bold')), 
            locations = cells_body(columns= c(GARW), 
                                   rows = 15)) %>%
      tab_style(style = list(
                         cell_text(weight = 'bold')), 
            locations = cells_body(columns= c(GARW), 
                                   rows = 16)) %>%
      tab_style(style = list(
                         cell_text(weight = 'bold')), 
            locations = cells_body(columns= c(GARW,MLR), 
                                   rows = 17)) %>%
      tab_style(style = list(
                         cell_text(weight = 'bold')), 
            locations = cells_body(columns= c(GARW), 
                                   rows = 18)) %>%
 # gt_theme_guardian()%>%
  tab_options(
      table.font.color = "black",
      table.font.size = px(14),
      table.layout = "auto") %>%
    opt_align_table_header("center")%>%
    tab_spanner(
    label = "Models",
    columns = c(Naïve,Piantham, MLR, FGA, GARW)) %>%
  tab_header(title = ("Performance statistics (µ absolute error)"))


table_1 %>%
  gtsave(filename = "table1.png", expand = 10)



```






#Analysis 2: Evaluate growth advatnage estimates per variant per country



```{r}

#plotting growth advantage per country

#Prepping datasets

#FGA AND MLR Dataset
ga_plot1 = growthadv_dataset %>%
  filter(model != 'GARW') 
#GARW dataset
ga_plot2 = growthadv_dataset %>%
  filter(model == 'GARW') %>%
  group_by(location, model,variant ,  pivot_date) %>%
  summarise(median_ga = mean(median_ga,na.rm = TRUE))

#FGA, MLR, and GARW
#GARW GA values are averaged over pivot_dates as it is varying
full_ga = ga_plot1 %>%
  full_join(ga_plot2)



```

##GA Estimates

```{r}
#Do models differ in their estimate of specific variant growth advantage?

#estimated growth advantage per variant 
violin_ga = full_ga %>%
  filter(location =="USA") %>%
  ggplot(aes(x = factor(variant), y = median_ga, color = variant)) +
  geom_violin(aes(fill = variant), size = 0.3,
              trim=FALSE, 
              position = "dodge", 
              alpha = 0.3,
              
              )+
    geom_beeswarm(alpha = 0.5,
                  size = 0.6) +
  facet_grid(location~model)+
    bbc_style()+
  xlab("Variant")+
  ylab("Median Growth Advantage")+
  coord_cartesian(ylim = c(0, 2.5))+
  scale_color_manual(values=c( "#4f34d2", "#5299e0", '#B66D0D', "#d00000", "#affc41", "#ff5a30", "474350"))+
  scale_fill_manual(values=c( "#4f34d2", "#5299e0", '#B66D0D', "#d00000", "#affc41", "#ff5a30", "474350"))+
        labs( x = "Pivot Date", y= "Median Growth Advantage")+
  theme(axis.title.x = element_text(color="Black", size=18),
        axis.title.y = element_text(color="Black", size=18),
        panel.grid.major = element_line(),
        axis.line = element_line(colour = "black"),
        panel.grid.major.y = element_blank(),
        panel.grid.minor.y = element_blank(),
        strip.text.x = element_text(size = 20, face = "bold"),
        strip.text.y = element_text(size = 20,  face = "bold"),
        legend.text = element_text(size = 20),
        axis.text.x = element_text(size = 14, angle = 90, vjust = 0.5, hjust=1),
        axis.text.y = element_text(size = 14))

violin_ga
ggsave("violin_ga.png", plot = violin_ga, width = 35, height = 25, units = "cm", bg='white' )

```



#Figure 3: stabilization between models

```{r}
#are different models consistent in their estimation of the median growth advantage of variants
#consistency between models

#do variants stabilize after certain period?
#comparing models growth advantage estimate
#consistency between models

max_val <- max(full_ga$median_ga)
number_ticks <- function(n) {function(limits) pretty(limits, n)}


class(variant_colorsga)
ga_models = full_ga %>% 
  filter(pivot_date != "2022-05-06") %>% 
  #filter(variant %in% c("Omicron 22A", "Omicron 22B", "Omicron 22C")) %>%
  ggplot(aes(y = median_ga, x = as.Date(pivot_date))) +
  geom_line(aes(color = variant)) +
  geom_point(aes(color = variant))+
  #geom_pointrange(size=0.2)+
  #scale_x_discrete(breaks=seq(-14, 14, 7)) +
  facet_grid(location~ model)+
  bbc_style()+
  xlab("Pivot Date")+
  ylab("Median Growth Advantage")+
  coord_cartesian(ylim = c(0, 5), expand = TRUE)+
 # "Omicron 21A" ="#4272CE", "Omicron 21B" = "#006494", "Omicron 21C" ="#D95D39"
  scale_color_manual(values = variant_colorsga)+
  scale_y_continuous(breaks = number_ticks(3))+
  
    #add ticks on x axis and y axis and make sure
  #theres an x axis for the countreis without the ticks
      labs( x = "Pivot Date", y= "Median Growth Advantage")+
  theme(axis.title.x = element_text(color="Black", size=14),
        axis.title.y = element_text(color="Black", size=14),
        panel.grid.major = element_line(),
        axis.line = element_line(colour = "black"),
        panel.grid.major.y = element_blank(),
        #panel.grid.minor.y = element_blank(),
        strip.text.x = element_text(size = 13),
        legend.text = element_text(size = 12),
        axis.text.x = element_text(size = 12),
        axis.text.y = element_text(size = 12),
        axis.ticks = element_line(), 
        strip.text.y = element_text(size = 11),
        plot.title = element_text(family = "Helvetica", size = (12)),
        legend.position = "top",
        legend.title = element_blank())
ga_models

ggsave("ga_models.png", plot = ga_models, width = 20, height = 20, units = "cm", bg='white' )


```












#Analysis 3: Sequencing efforts relation to data quality through model errors 


#Figure 4: Comparing emergence of variants to errors


```{r}


#Question: What is accurate prediction? What value is that so to know sequences is sufficient when we reach it??

#fit models on avg_seq that give error less than 0.05?
#fit models on avg seq that give error more than 0.05?


#subset the data to 50% of sequence and see what it looks like?

#normalize sequences? transform to 50%, 100% of given sequences?



n=length(filtered_data2$RMSE)
Z= sample(n,n/2)



#Plotting total sequences with mean RMSE values


#filter(location =="USA)
filtered_data2 %>%
  #filter(location =="Japan") %>%
  #filter(pivot_date == '2022-05-27') %>%
  group_by(location,variant, model, pivot_date) %>%
  summarise(RMSE = mean(RMSE, na.rm= TRUE), total_seq = total_seq) %>%
  #filter(total_seq > 0 & total_seq <200 ) %>%
  ggplot(aes(x =total_seq, y = RMSE, color = model)) +
  facet_wrap(location~variant, ncol = 3)+
  #geom_point()+
  geom_line()+
  theme_classic()


filtered_data22 = subset(filtered_data2, RMSE < 0.05)
filtered_data22

```



```{r}
#investigate how sequence count affect error of different models


#nans are creating in the summarise
filtered_data2 %>%
  filter(location =="USA") %>%
  group_by(location, model, pivot_date) %>%
  summarise(RMSE = mean(RMSE, na.rm= TRUE), avg_seq = mean(total_seq,  na.rm = TRUE)) %>%
  ggplot(aes(x =avg_seq, y = RMSE, color = model)) +
  facet_wrap(~location, ncol = 1)+
  geom_point()+
  theme_classic()


#average sequences relation with RMSE AND MAE errors

filtered_data2 %>%
  group_by(location, model, pivot_date) %>%
  summarise(RMSE = sqrt(mean(RMSE^2, na.rm = TRUE)), 
            avg_seq = mean(total_seq,  na.rm = TRUE),
            MAE = mean(MAE, na.rm = TRUE)) %>%
  ggplot() +
  facet_wrap(~location, ncol = 1)+

  geom_point(aes(x =avg_seq, y = MAE, color = model))+
  geom_point(aes(x =avg_seq, y = RMSE))+
             theme_classic()



m1

```


```{r}

closest_pivot_date = function(pivot_dates, date_submitted){
  first_value = sapply(date_submitted, function(x) min(which(x < pivot_dates)))
  return(pivot_dates[first_value])
}



#get 




emergence_date = error_dataset %>%
  group_by(variant, location) %>%
  mutate(emeregence_freq = smoothed_freq >= 0.01) %>%
  filter(emeregence_freq == TRUE) %>%
  summarise(emergence_date = min(date)) %>%
  ungroup()

emerge_dt = error_dataset %>%
  filter(!(variant %in% c("Delta", "other"))) %>%
  left_join(emergence_date, by = c("variant", "location"))




  

#define emergent periods for each country
  #Emergent dates for a country and (-30,+30)

#errors should arise near the any of the dates of emergence 


#Looking at a grid of country + emergent period and looking at MAE in that period


#min date of introduction



#seperate figure for each introduction, filter to a certain variant 


#what happens if we took the estimates of 22C as it didn't exist, how different our estimates be for the other


emergent_variant = emergence_date %>%
  filter(variant =="Omicron 22C") %>%
  select(location, emergence_date)


emerge_dt = error_dataset %>%
  filter(!(variant %in% c("Delta", "other"))) %>%
  left_join(emergent_variant, by = c("location"))





#For each variant emergence, how is that affecting other variant error in estimation
emerge_dt %>%
  ggplot(aes(x = as.Date(date) - as.Date(emergence_date), y = MAE, color = variant))+
  geom_point()+
  facet_grid(variant~location)+
scale_color_manual(values = variant_colors)+
  xlim(-30,30) +
  bbc_style()+
    theme(axis.title.x = element_text(color="Black", size=14),
        axis.title.y = element_text(color="Black", size=14),
        panel.grid.major.x = element_line(color = "grey",
                                          size = 0.4, linetype = 2),
        axis.line = element_line(colour = "black"),
        panel.grid.major.y = element_blank(),
        panel.grid.minor.y = element_blank(),
        strip.text.x = element_text(size = 13),
        legend.text = element_text(size = 12),
        axis.text.x = element_text(size = 12),
        axis.text.y = element_text(size = 12),
        axis.ticks = element_line(), 
        strip.text.y = element_text(size = 11),
        plot.title = element_text(family = "Helvetica", size = (12)),
        legend.position = "top",
        legend.title = element_blank())+
  xlab("Date from Omicron 22C emergence")


#For each variant emergence, how is that affecting other variant error in estimation
emerge_dt %>%
  ggplot(aes(x = as.Date(date) - as.Date(emergence_date), y = MAE, color = variant))+
  geom_smooth()+
  facet_wrap(~location)+
  xlim(-30,30) +
    scale_color_manual(values = variant_colors)+
  bbc_style()+
    theme(axis.title.x = element_text(color="Black", size=14),
        axis.title.y = element_text(color="Black", size=14),
        panel.grid.major.x = element_line(color = "grey",
                                          size = 0.4, linetype = 2),
        axis.line = element_line(colour = "black"),
        panel.grid.major.y = element_blank(),
        panel.grid.minor.y = element_blank(),
        strip.text.x = element_text(size = 13),
        legend.text = element_text(size = 12),
        axis.text.x = element_text(size = 12),
        axis.text.y = element_text(size = 12),
        axis.ticks = element_line(), 
        strip.text.y = element_text(size = 11),
        plot.title = element_text(family = "Helvetica", size = (12)),
        legend.position = "top",
        legend.title = element_blank()) +
  xlab("Date from Omicron 22C emergence")


#how much difference

emerge_dt %>%
  ggplot(aes(x = as.Date(date) - as.Date(emergence_date), y = order(MAE)))+
  geom_area(aes(color = factor(variant), fill = factor(variant)), stat = "identity")+
     stat_smooth(
       geom = 'area', method = 'loess', span = 1/3, fill = "red")+
  facet_grid(~location)+
  xlim(-30,30)
+
    scale_fill_manual(values = variant_colors)+
  bbc_style()+
    theme(axis.title.x = element_text(color="Black", size=14),
        axis.title.y = element_text(color="Black", size=14),
        panel.grid.major.x = element_line(color = "grey",
                                          size = 0.4, linetype = 2),
        axis.line = element_line(colour = "black"),
        panel.grid.major.y = element_blank(),
        panel.grid.minor.y = element_blank(),
        strip.text.x = element_text(size = 13),
        legend.text = element_text(size = 12),
        axis.text.x = element_text(size = 12),
        axis.text.y = element_text(size = 12),
        axis.ticks = element_line(), 
        strip.text.y = element_text(size = 11),
        plot.title = element_text(family = "Helvetica", size = (12)),
        legend.position = "top",
        legend.title = element_blank()) +
  xlab("Date from Omicron 22C emergence")

  
  
  

emerge_dt

#modelling: does emergence data relate to MAE errors of variant
mm = lm(MAE~emergence_date, data =emerge_dt )
summary(mm)
plot(mm)
```

















#*Supplementary Figures*

##Data filtering and preparation
 
```{r}
#filter and prep data

#dataframe 1 
filtered_data = error_dataset %>%
  group_by(lead) %>%
  filter(location =='USA' & variant == 'Omicron 21K' &
           model != 'MLR')

#dataframe 2
filtered_data2 = error_dataset %>% 
  filter(lead >= -13) %>%
  filter(!(pivot_date == "2022-04-22" &
           location == "United Kingdom")) %>%
  filter(date < "2022-07-01")

#dataframe 3
filtered_data3 = error_dataset %>% 
  filter(location =="USA") 

#dataframe 4
filtered_data4 = error_dataset %>% 
  filter(location =="USA" &
           model =="GARW") 

```


```{r}

#Helper Functions

closest_pivot_date = function(pivot_dates, date_submitted){
  first_value = sapply(date_submitted, function(x) min(which(x < pivot_dates)))
  return(pivot_dates[first_value])
}

pivot_dates = error_dataset %>%
  select(pivot_date) %>%
  arrange(pivot_date) %>%
  distinct(pivot_date)

seq_date$nearest_pivot= closest_pivot_date(pivot_dates$pivot_date, seq_date$date_submitted)

#apply consistent axis

apply_consistent_y_lims <- function(this_plot){
    num_plots <- length(this_plot$layers)
    y_lims <- lapply(1:num_plots, function(x) ggplot_build(this_plot[[x]])$layout$panel_scales_y[[1]]$range$range)
    min_y <- min(unlist(y_lims))
    max_y <- max(unlist(y_lims))
    this_plot & ylim(min_y, max_y)
}


apply_consistent_x_lims <- function(this_plot){
    num_plots <- length(this_plot$layers)
    x_lims <- lapply(1:num_plots, function(x) ggplot_build(this_plot[[x]])$layout$panel_scales_x[[1]]$range$range)
    min_x <- min(unlist(x_lims))
    max_x <- max(unlist(x_lims))
    this_plot & xlim(min_x, max_x)
}




```






##Figure 1: submission by pivot_date

##plot 2: submission delays


```{r}

#using all estimated dates seq counts by pivot date colored by gradient
submit_delay = seq_date %>%
  arrange(date_submitted) %>%
  ggplot() +
  geom_col(aes(x = as.Date(date), y = sequences, fill = as.Date(date_submitted)))+
  bbc_style()+
  scale_fill_gradient(
  name = "Date of Estimation",
  low = low_color,
  high = high_color,
  guide = "colorbar",
  limits = as.Date(c("2022-01-01", "2022-06-30")),
  space = "Lab",
  na.value = NA,
  breaks = as.Date(c("2022-01-01","2022-03-15", "2022-05-30")),
  labels = c("April", "May", "June"),
  aesthetics = "fill")+
  labs( x = "Date", y= "Sequence")+
  theme(axis.title.x = element_text(color="Black", size=14),
        axis.title.y = element_text(color="Black", size=14),
        panel.grid.major = element_line(),
        axis.line = element_line(colour = "black"),
        panel.grid.major.y = element_blank(),
        panel.grid.minor.y = element_blank(),
        strip.text.x = element_text(size = 15),
        legend.text = element_text(size = 12),
        axis.text.x = element_text(size = 12),
        axis.text.y = element_text(size = 12),
        axis.ticks = element_line(), 
        strip.text.y = element_text(size = 11),
        plot.title = element_text(family = "Helvetica", size = (12)),
        legend.position = "right",
        legend.title = element_text(size = 12)) 

#+ggtitle("United States")

submit_delay


```




```{r}


#freq plot submitted date

freq_plot = error_dataset %>% 
  filter(location =="USA" &
           model =="GARW") %>%
  filter(variant != "other" & variant != "Delta") %>%
  ggplot() +
    geom_line(aes(x = as.Date(date), y = smoothed_freq),color = "darkgrey" ,size = 1.4)+
  geom_line(aes(x = as.Date(date), y = pred_freq,  group = factor(pivot_date), color = as.Date(pivot_date) ), size = 1, alpha = 0.5)+
  facet_wrap(~variant)+
  bbc_style()+
  scale_colour_gradient(
  low = low_color,
  high = high_color,
  limits = as.Date(c("2022-01-01", "2022-06-30")),
  #space = "Lab",
  #na.value = NA,
  breaks = as.Date(c("2022-01-01","2022-03-15", "2022-05-30")),
  labels = c("April", "May", "June"),
  guide = "colourbar",
  aesthetics = "colour") +
  labs( x = "Date", y= "Frequency",
        caption = "MA smoothed frequency with predicted frequency")+
  theme(axis.title.x = element_text(color="Black", size=14),
        axis.title.y = element_text(color="Black", size=14),
        panel.grid.major = element_line(),
        axis.line = element_line(colour = "black"),
        panel.grid.major.y = element_blank(),
        panel.grid.minor.y = element_blank(),
        strip.text.x = element_text(size = 15),
        legend.text = element_text(size = 12),
        axis.text.x = element_text(size = 12),
        axis.text.y = element_text(size = 12),
        axis.ticks = element_line(), 
        strip.text.y = element_text(size = 11),
        plot.title = element_text(family = "Helvetica", size = (12)),
        legend.position = "none")
#+ggtitle("United States - GARW")

freq_plot






ggsave("freq_plot.png", plot = freq_plot, width = 20, height = 20, units = "cm" )



```





```{r}

#different pivot dates error distribution at important lead time points (geom_ridges)

lags = as_labeller(c("-13" = "-14 Lag", "0" = "0 Lag","14"= "14 Lag"))

desc_stat2 = error_dataset %>%
    filter(lead %in% c(0,14,-13)) %>%
    group_by(lead, model) %>%
  summarize(sd = sd(RMSE, na.rm = T),
            RMSE = mean(RMSE, na.rm = T)
            ) %>%
  mutate_if(is.numeric, round, digits=2) %>%
    mutate(lab = paste0( "µ = ", RMSE,
                         "\nσ = ", sd))



rmse_dist = error_dataset %>%
  filter(lead %in% c(0,14,-13)) %>%
  group_by(lead, location, model) %>%
  ggplot(aes(x = RMSE, y = factor(model, levels = c("Naïve","MLR","Piantham","FGA","GARW")), fill = model, alpha = 0.7)) +
  scale_fill_manual(values = model_colors)+
geom_density_ridges(stat = "binline", bins = 15, scale = 0.95, draw_baseline = F)+
      bbc_style()+
  facet_wrap(~as.factor(lead), labeller = lags)+
    labs(x = "RMSE score distribution")+
    theme(axis.title.x = element_text(color="Black", size=14),
        panel.grid.major = element_line(),
        axis.line = element_line(colour = "black"),
        panel.grid.major.y = element_blank(),
        strip.text.x = element_text(size = 13),
        legend.text = element_text(size = 12),
        axis.text.x = element_text(size = 12),
        axis.text.y = element_text(size = 12),
        axis.ticks = element_line(), 
        strip.text.y = element_text(size = 11),
        plot.title = element_text(family = "Helvetica", size = (12)),
        legend.position = "right",
        legend.title = element_text(size = 12))+
 scale_alpha(guide = 'none') +
    #scale_x_continuous( trans  = compose_trans("log10", "reverse"),
     #                   breaks = c(100, 10, 1))+
                     #breaks = trans_breaks('logit', function(x) 10^x))+
                     #limits = c(10^(-5),0),
                     #labels = trans_format('log10', math_format(10^.x)))+
   # scale_x_continuous(trans = "log",
                      # limits = c(0 ,0.01 , 0.0 , 7, 1),
                  #  breaks = c(-14 ,-7 , 0 , 7, 14),
                     # labels=c("25%","10%","5%","1%","0%"),
                    #  expand = expansion(mult  = 0.10))+
                     #breaks = trans_breaks(function(x) c(1, 100)),
                    # labels = percent)+
  labs(fill="Estimated Lag")
  #scale_x_percent()

rmse_dist= rmse_dist +
  geom_text(data= desc_stat2, aes(label = lab) , alpha = 1 ,x = 1.3, hjust=2, vjust=-2, size=3, color="black", fontface = 1, font="AvantGarde")



rmse_dist



ggsave("figure2.B.png", plot = mae_dist, width = 20, height = 20, units = "cm", bg ='transparent')







```


```{r}

library("ggforce")

library("scales")
reverselog_trans <- function(base = exp(1)) {
    trans <- function(x) -log(x, base)
    inv <- function(x) base^(-x)
    trans_new(paste0("reverselog-", format(base)), trans, inv, 
              log_breaks(base = base), 
              domain = c(1e-100, Inf))
}



```









#Plotting error by lead
##Pirateplot & boxplot







```{r}

# Pirate RSME plot for each location and model
rsme_plot = error_dataset %>%
  ggplot(aes(factor(lead), -loglik)) +
  geom_pirate(aes(colour= model, fill = model), show.legend = TRUE,
              bars = FALSE,
              lines = TRUE, 
              violins = TRUE,
              points = TRUE,
              jitter_width = 0.2,
              points_params = list(shape = 19, alpha = 0.5),
              violins_params = list(size = 0.5, alpha = 0, width = 0.7),
              na.rm = FALSE) +
              facet_grid(location~model)+
  scale_x_discrete(breaks=seq(-14, 14, 7)) +
  geom_vline(xintercept = "0", linetype = 2) +
  bbc_style() +
  scale_color_manual(values=c("darkgrey", "#56B4E9", "#E69F00", '#FD1C03', "purple"))

rsme_plot


#Check GARW error
rsme_plot2 = filtered_data2 %>%
  ggplot(aes(lead, RMSE, fill= model, color = model))+
  geom_boxplot(position=position_dodge(1), outlier.shape = NA, varwidth = FALSE)+
  facet_wrap(~location, ncol= 1)+
  scale_x_discrete(breaks=seq(-14, 14, 7)) +
  geom_vline(xintercept = "0", linetype = 2) +
  bbc_style() +
  coord_cartesian(ylim = c(0, 0.3))+
    labs( x = "Lead", y= "RMSE")+
  theme(axis.title.x = element_text(color="Black", size=15),
        axis.title.y = element_text(color="Black", size=15),
        panel.grid.major = element_line(),
        axis.line = element_line(colour = "black"),
        panel.grid.major.y = element_blank(),
        panel.grid.minor.y = element_blank(),
        strip.text.x = element_text(size = 14, face = "bold"),
        strip.text.y = element_text(size = 14,  face = "bold"),
        legend.text = element_text(size = 15),
        axis.text.x = element_text(size = 12),
        axis.text.y = element_text(size = 12))
  

rsme_plot2

rsme_plot3 = filtered_data2 %>%
  ggplot(aes(lead, RMSE, fill= model, color = model))+
  #geom_point()+
  #geom_quantile(quantiles = seq(.1, .9, by = .5))+
  stat_quantile(quantiles = c(0.25, 0.5, 0.75),
                show.legend = TRUE)+
  #geom_boxplot(position=position_dodge(1), outlier.shape = NA, varwidth = FALSE)+
  facet_wrap(~location, ncol= 1)+
  scale_x_discrete(breaks=seq(-14, 14, 7)) +
  geom_vline(xintercept = "0", linetype = 2) +
  bbc_style() +
  coord_cartesian(ylim = c(0, 0.3))+
    labs( x = "Lead", y= "RMSE")+
  theme(axis.title.x = element_text(color="Black", size=15),
        axis.title.y = element_text(color="Black", size=15),
        panel.grid.major = element_line(),
        axis.line = element_line(colour = "black"),
        panel.grid.major.y = element_blank(),
        panel.grid.minor.y = element_blank(),
        strip.text.x = element_text(size = 14, face = "bold"),
        strip.text.y = element_text(size = 14,  face = "bold"),
        legend.text = element_text(size = 15),
        axis.text.x = element_text(size = 12),
        axis.text.y = element_text(size = 12))
rsme_plot3


ggsave("RMSE_plot3.png", plot = rsme_plot3, width = 20, height = 20, units = "cm" )



ggsave("RMSE_plot2.png", plot = rsme_plot2, width = 20, height = 20, units = "cm" )

```



This plot shows the progression of error by model for each country where the lead (0) represented the run date of the model and 0-7 is the nowcast prediction values and 7-14 is the forecasted values. 



```{r}


# Pirate MAE plot for each location and model
mae_plot = error_dataset %>%
  ggplot(aes(factor(lead), MAE)) +
  geom_pirate(aes(colour= model, fill = model), show.legend = TRUE,
              bars = FALSE,
              lines = TRUE, 
              violins = FALSE,
              points = FALSE,
              jitter_width = 0.2,
              points_params = list(shape = 19, alpha = 0.5),
              violins_params = list(size = 0.5, alpha = 0, width = 0.7),
              na.rm = FALSE) +
              facet_grid(location~model)+
  scale_x_discrete(breaks=seq(-14, 14, 7)) +
  geom_vline(xintercept = "0", linetype = 2) +
  theme_classic() +
  scale_color_manual(values= model_colors)

mae_plot

#ggsave("MAE_plot.png", plot = mae_plot, width = 20, height = 20, units = "cm" )

```

```{r}

#plot3: stacked plot RMSE

stacked_rmse = filtered_data2 %>%
  group_by(location, model) %>%
  ggplot(aes(factor(lead), RMSE, color = model, fill = model)) +
  facet_wrap(.~location,ncol = 1,scales = 'free_y')+
    geom_pirate(aes(fill= model),
              violins = TRUE,
               bars = FALSE,
               cis = FALSE,
              points = TRUE,
              show.legend = TRUE,
              points_params = list(shape = 20, alpha = 0.5)) +
  scale_x_discrete(breaks=seq(-14, 14, 7)) +
  geom_vline(xintercept = "0", linetype = 2) +
  bbc_style()+
  scale_color_manual(values=c("darkgrey", "#56B4E9", "#E69F00", '#4F6272', "purple"))+
    labs( x = "Lead", y= "RMSE")+
  theme(axis.title.x = element_text(color="Black", size=14),
        axis.title.y = element_text(color="Black", size=14),
        panel.grid.major = element_line(),
        axis.line = element_line(colour = "black"),
        panel.grid.major.y = element_blank(),
        panel.grid.minor.y = element_blank(),
        strip.text.x = element_text(size = 15),
        legend.text = element_text(size = 12),
        axis.text.x = element_text(size = 12),
        axis.text.y = element_text(size = 12))

stacked_rmse
ggsave("stacked_rmse.png", plot = stacked_rmse, width = 20, height = 20, units = "cm" )

```


```{r}
#Plot4:model smoothed lines comparison

rsme_smoothed = filtered_data2 %>%
  ggplot(aes(lead, RMSE, color = model)) +
  #geom_point( position=position_jitter(h=0.1, w=0.1),
   #          shape = 20, alpha = 0.6, size = 1.5)+
  facet_wrap(.~location,ncol = 1,scales = 'free_y')+
  geom_smooth() +
  scale_x_continuous(breaks=seq(-14, 14, 7)) +
  theme_classic() +
  scale_color_manual(values=c("darkgrey", "#56B4E9", "#E69F00", '#4F6272',"purple"))
rsme_smoothed

mae_smoothed = filtered_data2 %>%
  ggplot(aes(lead, MAE, color = model)) +
  facet_wrap(.~location,ncol = 1 ,scales = 'free_y')+
  geom_smooth(show.legend = TRUE) +
  scale_x_continuous(breaks=seq(-14, 14, 7)) +
  theme_classic() +
  scale_color_manual(values=c( "#56B4E9", "#E69F00", '#4F6272',"purple"))



error_smoothed = rsme_smoothed + mae_smoothed & theme(legend.position = "bottom")
error_smoothed = error_smoothed + plot_layout(guides = "collect")


error_smoothed
ggsave("error_smooted.png", plot = error_smoothed, width = 20, height = 20, units = "cm" )


```

#growth advantage ridges


#ridges plot

```{r}



library(ggridges)

p1 = full_ga %>%
  filter(location =="USA") %>%
  ggplot(aes(x =median_ga, y=  factor(variant), color = variant, fill = variant))+
  geom_density_ridges_gradient(scale = 2, rel_min_height = 0.01) +
  facet_grid(~model)+
    bbc_style()+
    theme(
      legend.position="bottom",
      panel.spacing = unit(0.1, "lines"),
      strip.text.x = element_text(size = 8)
    )+
          labs( x = "Median Growth Advantge", y= "Variant")+
  theme(axis.title.x = element_text(color="Black", size=15),
        axis.title.y = element_text(color="Black", size=15),
        panel.grid.major = element_line(),
        axis.line = element_line(colour = "black"),
        panel.grid.major.y = element_blank(),
        panel.grid.minor.y = element_blank(),
        strip.text.x = element_text(size = 14, face = "bold"),
        strip.text.y = element_text(size = 14,  face = "bold"),
        legend.text = element_text(size = 15),
        axis.text.x = element_text(size = 12),
        axis.text.y = element_text(size = 12))

p1
p2 =  full_ga %>%
  filter(location =="United Kingdom") %>%
  ggplot(aes(x =median_ga, y=  factor(variant), color = variant, fill = variant))+
  geom_density_ridges_gradient(scale = 2, rel_min_height = 0.01) +
  facet_grid(~model)+
    bbc_style() +
    theme(
      legend.position="bottom",
      panel.spacing = unit(0.1, "lines"),
      strip.text.x = element_text(size = 8)
    )+
  labs( x = "Median Growth Advantge", y= "Variant")+
  theme(axis.title.x = element_text(color="Black", size=15),
        axis.title.y = element_text(color="Black", size=15),
        panel.grid.major = element_line(),
        axis.line = element_line(colour = "black"),
        panel.grid.major.y = element_blank(),
        panel.grid.minor.y = element_blank(),
        strip.text.x = element_text(size = 14, face = "bold"),
        strip.text.y = element_text(size = 14,  face = "bold"),
        legend.text = element_text(size = 15),
        axis.text.x = element_text(size = 12),
        axis.text.y = element_text(size = 12))
  
m = p1/p2
m
ggsave("ga_var.png", plot = m, width = 20, height = 20, units = "cm" )
ggsave("ga_var_US.png", plot = p1, width = 20, height = 20, units = "cm" )



```










